<!doctype html>
<html>
<head>
	<meta charset='utf-8' />
	<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
	<title>unidb</title>
	<style>
		body{margin:0 auto;word-break:break-all;font-family:"宋体";}
		@media screen and (min-width:600px){body{width:600px}}
		@media screen and (max-width:600px){body{width:100% }}
		.wechetbt{font-size:30px;background:#090;height:42px;color:#fff;line-height:42px;}
		.wechetbt img{width:40px;height:40px;float:left;border-radius:10px;margin:0 20px;border:1px solid #ff0;}
		#dog {width: 200px; border-radius:10px; font-size: 14px;}
		#dog div{margin-top: 20px; text-align: right;}
		#dog button{margin-left: 20px;}
		textarea {width:99%;overflow: auto;word-break: break-all;resize: none;background-color: #D5EAF0;}
	</style>
</head>
<body>
	<div class="wechetbt"><img id="head" src="https://zhr577.gitee.io/img/head.jpg"/><text id="nickname"></text></div>
	<div>
		<input id='id' />
		<input id='date' />
		<textarea id='data1' rows=10></textarea>
		<textarea id='data2' rows=10></textarea>
		<button id='duqu'>读取</button>
		<button id='save'>保存</button>
		<button id='maxid'>获取</button>
	</div>
	<div id='a'></div>
	<div id='b'></div>
	<dialog id='dog'>
		<p>message</p>
		<div>
			<text id='dogbtn'></text>
			<text><button onclick=dog.close()>关闭</button></text>
		</div>
	</dialog>
</body>
</html>
<script src="https://zhr577.gitee.io/js/jquery.min.js" type="text/javascript"></script>
<script src="https://zhr577.gitee.io/js/aes.js" type="text/javascript"></script>
<script>
	var data={}
	data.dbname = 'wy'
	data.serverurl = "https://lm.hao933.top:89"
	data.uniurl = "https://fc-mp-119e35e3-c626-4e18-bdb1-b10921c7ee46.next.bspapp.com/unidb"
	$(document).ready(async ()=>{
		startrun()
		await getopid();getuser()
		if(data.opid.length==28){
			//getdb()
		}
	})
	function getopid(){
		return new Promise((resolve,reject)=>{
			let cokopid = getCookie('opid')
			if(cokopid.length==28){data.opid = cokopid;resolve();return}
			let code = getUrlParam('code')
			$("#a").html(code+'<br>')
			if(code && code.length==32){
				$.ajax({
					url:data.serverurl + '/myapi/code.php',
					data:{code,mode:'opid'},
					type:'get',
					dataType:'jsonp',
					async:false,
					success:function(resp){
						data.opid=resp[0]
						data.token=resp[1]
						setCookie("opid",data.opid,1)
						resolve()
					}
				})
			}else{
				let url = data.serverurl + "/myapi/code.php?state="
				let str = window.location.protocol+"//"+window.location.host+""+window.location.pathname
				str = str.replace(/\./g,"0d0")
				str = str.replace(/\//g,"0g0")
				str = str.replace(/\:/g,"0m0")
				url += str
				window.location.replace(url)
				resolve()
			}
		})
	}
	function getuser(){
		if(!data.opid){$("#a").html("请先登录");return}
		$.ajax({
			type:'get',
			url: data.serverurl + '/myapi/code.php',
			data:{opid:data.opid,token:data.token},
			dataType:'jsonp',
			async:false,
			success:function(resp){
				data.nickname = resp.nickname
				data.headimgurl = resp.headimgurl
				data.tm = resp.tm
				let tm0 = (new Date().getTime()) / 1000
				let tm = ((data.tm - tm0) / 60).toFixed(0)
				$("#head").attr("src",data.headimgurl);
				$("#nickname").text(data.nickname+" "+tm);
				if(tm < 0){reuser()}
				return
			}
		})
	}
	function reuser(){
		var keys = document.cookie.match(/[^ =;]+(?=\=)/g);
		if (keys) {
			for (var i = keys.length; i--;) {
				document.cookie = keys[i] + '=0;path=/;expires=' + new Date(0).toUTCString();
				document.cookie = keys[i] + '=0;path=/;domain=' + document.domain + ';expires=' + new Date(0).toUTCString();//
				document.cookie = keys[i] + '=0;path=/;domain=kevis.com;expires=' + new Date(0).toUTCString();
			}
		}
		$("#b").html("已注销登录")
		//window.location.href=data.url
	}
	function setCookie(cname,cvalue,exdays){
		var d = new Date();
		d.setTime(d.getTime()+(exdays*24*60*60*1000));
		var expires = "expires="+d.toGMTString();
		document.cookie = cname + "=" + cvalue + "; " + expires;
	}
	function getCookie(cname){
		var name = cname + "=";
		var ca = document.cookie.split(';');
		for(var i=0; i<ca.length; i++){
			var c = ca[i].trim();
			if (c.indexOf(name)==0) return c.substring(name.length,c.length);
		}
		return "";
	}
	function displayCookies(){var ca = document.cookie.replace(/;/g,"<br>");$("#a").html(ca)}
	function getUrlParam(name){
		var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)")
		var r = window.location.search.substr(1).match(reg)
		if (r != null) return unescape(r[2])
		return null
	}
//===========================================================================
	function getdb(){
		$.ajax({
			url:data.uniurl,
			data:{opid:data.opid,mode:1,dbname:data.dbname,id:0},
			type:'get',
			dataType:'json',
			async:false,
			success:function(resp){
				data._id=resp.data[0]._id
				data.id=resp.data[0].id
				data.date=timestampToTime(resp.data[0].date).slice(0, 10)
				data.data1=resp.data[0].data1
				data.data2=resp.data[0].data2
				$('#id').val(data.id)
				$('#date').val(data.date)
				$('#data1').val(data.data1)
				$('#data2').val(data.data2)
			}
		})
	}
	function updb(){
		let id = $('#id').val()
		let date = $('#date').val()
		let data1 = $('#data1').val()
		let data2 = $('#data2').val()
		if(isNaN(Date.parse(date)) || date.replace(/ /g,'').length !=10){$("#dog p").html('日期格式不正确');	dog.showModal();return}
		date += ' 20:00:00'
		if(!data._id || data._id.length<24){
			$("#dog p").html('_id错误');	dog.showModal()
			return
		}
		$.ajax({
			url:data.uniurl,
			data:{opid:data.opid,mode:2,dbname:data.dbname,_id:data._id,id,date:Date.parse(date),data1,data2},
			type:'get',
			dataType:'json',
			async:false,
			success:function(resp){
				$("#dog p").html('保存成功');dog.showModal()
				return
			}
		})
	}
	function newdb(){
		let id = $('#id').val()
		let date = $('#date').val()
		let data1 = $('#data1').val()
		let data2 = $('#data2').val()
		if(isNaN(Date.parse(date)) || date.replace(/ /g,'').length !=10){$("#dog p").html('日期格式不正确');	dog.showModal();return}
		date += ' 20:00:00'
		$.ajax({
			url:data.uniurl,
			data:{opid:data.opid,mode:4,dbname:data.dbname,_id:data._id,id,date:Date.parse(date)/1000,data1,data2},
			type:'get',
			dataType:'json',
			async:false,
			success:function(resp){
				//$("#dog p").html('保存成功');dog.showModal()
				maxid()
				return
			}
		})
	}
	function maxid(){
		$.ajax({
			url:data.uniurl,
			data:{opid:data.opid,mode:3,dbname:data.dbname},
			type:'get',
			dataType:'json',
			async:false,
			success:function(resp){
				if(resp.data.length==0){
					var id = 1
				}else{
					var id = resp.data[0].id
					id++
				}
				sqldb(id)
			}
		})
	}
	function startrun(){
		document.getElementById("duqu").addEventListener("click",()=>{getdb()})
		document.getElementById("save").addEventListener("click",()=>{updb()})
		document.getElementById("maxid").addEventListener("click",()=>{maxid()})
	}
	function timestampToTime(timestamp) {
		var date = new Date(timestamp * 1000);//时间戳为10位需*1000，时间戳为13位的话不需乘1000
		var Y = date.getFullYear() + '-';
		var M = (date.getMonth()+1 < 10 ? '0'+(date.getMonth()+1) : date.getMonth()+1) + '-';
		var D = (date.getDate() < 10 ? '0'+(date.getDate()) : date.getDate()) + ' ';
		var h = date.getHours() + ':';
		var m = date.getMinutes() + ':';
		var s = date.getSeconds();
		return Y+M+D+h+m+s;
	}
	async function sqldb(id){
		let db = await new Promise((resolve,reject)=>{
			let db0 = {}
			db0.mode = 1
			db0.opid = data.opid
			db0.sql = "select * from wy where id = " + id
			let db1 = js_encrypt(JSON.stringify(db0),"52c7f81cd24c9699","42e07d2f7199c35d")
			$("#a").html(db1)
			$.ajax({
				type: "get",
				url: data.serverurl + "/myapi/webapi.php",
				data:{db1},
				dataType: "jsonp",
				jsonp: "callback",
				success: function(db){resolve(db)},
				error: function(db){resolve(db)}
			})
		})
		$("#id").val(db[0].id)
		$("#date").val(db[0].time.slice(0, 10))
		$("#data1").val(db[0].data1)
		$("#data2").val(db[0].data2)
		newdb()
	}
	function js_encrypt(str, key, iv) {
		key = CryptoJS.enc.Utf8.parse(key);
		iv = CryptoJS.enc.Utf8.parse(iv);
		let encrypted = CryptoJS.AES.encrypt(str, key, {
			iv: iv,	mode: CryptoJS.mode.CBC,padding: CryptoJS.pad.Pkcs7
		})
		return encrypted.toString()
	}
	function js_decrypt(str, key, iv) {
		key = CryptoJS.enc.Utf8.parse(key);
		iv = CryptoJS.enc.Utf8.parse(iv);
		let decrypted = CryptoJS.AES.decrypt(str, key, {
			iv: iv,padding: CryptoJS.pad.Pkcs7
		}).toString(CryptoJS.enc.Utf8);
		return decrypted
	}
</script>