<html>
<head>
	<head>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
    <title>MF</title>
		<style type="text/css">
		body{margin:0 auto;word-break:break-all;}
		@media screen and (min-width:400px) {body {width: 400px}}
		@media screen and (max-width:400px) {body {width: 99%}}
		.wechetbt{font-size:30px;background:rgb(0, 114, 0);height:42px;color:#fff;line-height:42px;}
		.wechetbt img{width:40px;height:40px;float:left;border-radius:10px;margin:0 20px;border:1px solid rgb(196, 196, 0);}
		p{margin:0px auto;width:100%;}
		.item{border-right:1px solid #777777;border-bottom:2px solid #000000;
			border-radius: 10px;margin: 5px;padding: 10px;}
		.itembt{background: #c76f6f;color:#fff;width:160px;border-radius: 3px;text-align: center;cursor: pointer;}
		.itembz{min-height: 50px;}
		.item11{text-align: right; color:blue}
		.itemxq{color: #c76f6f;}
		#mon, #ssstr{font-size: 20px;width: 85px;cursor: default;}
		button{width:60px;height:27px;margin-left: 10px;}
		textarea {width: 100%;overflow: auto;word-break: break-all;resize: none;}
		table {width: 100%;border-collapse: collapse;}
		td {border-collapse: collapse;border: 1px solid #7ab;text-align: center;
			font-size: 14px;cursor: default;width: 1}
		#addtab input {width: 150px;border: 0px;text-align: center;}
		#dog {width: 200px; border-radius:10px; font-size: 14px;}
		#dog div{margin-top: 20px; text-align: right;}
		#dog button{margin-left: 20px;}
	</style>
</head>
<body>
	<div class="wechetbt">
		<img id="head" src="http://zhr577.gitee.io/img/head.jpg"/>
		<text id="nickname"></text><text id="tishi"></text>
	</div>
	<div id="a"></div>
	<div id="b"></div>
	<dialog id='dog'><p>message</p><div><text id='dogbtn'></text><text><button onclick=dog.close()>关闭</button></text></div></dialog>
</body>
</html>
<script src="http://zhr577.gitee.io/js/jquery.min.js" type="text/javascript"></script>
<script src="http://zhr577.gitee.io/js/DatePicker.js" type="text/javascript"></script>
<script src="http://zhr577.gitee.io/js/aes.js" type="text/javascript"></script>
<script src="opid.js" type="text/javascript"></script>
<script type="text/javascript">
	data.sqlname = 'myfamily'
    data.date1 = new Date(Date.parse(new Date)+28800000).toISOString().slice(0, 7)
	data.year0 = new Date(Date.parse(new Date)+28800000).toISOString().slice(0, 4)
	data.ssstr = ""
    $(document).ready(async function(){
        history.pushState(null, null, null)
        window.addEventListener('popstate', function () {history.pushState(null, null, null)})
        $('#b').html(window.location.href)
        await getopid();getuser()
		if(data.opid.length==28){await getdb(1)}
    })
	async function getdb(x){
		let db0 = {}
		db0.mode = 1
		db0.opid = data.opid
		if(x==1){
			let date1 = data.date1 + '-01'
			let date2 = nextmon(data.date1) + '-01'
			db0.sql = `select * from ${data.sqlname} where time >= '${date1}' and time <= '${date2}' order by time limit 5000`
		}
		if(x==2){
			let date1 = data.year0 + '-01-01'
			let date2 = data.year0 + '-12-31 23:59:59'
			db0.sql = `select * from ${data.sqlname} where time >= '${date1}' and time <= '${date2}' and data1 like '%${data.ssstr}%' COLLATE utf8_general_ci order by time limit 500`
		}
		let db1 = js_encrypt(JSON.stringify(db0),"52c7f81cd24c9699","42e07d2f7199c35d")
		$("#a").html(db0.sql)
		let errstr = '获取数据失败<button onclick=getdb(1)>重试</button>'
		let db = await new Promise((resolve,reject)=>{$.ajax({
			type: "get",dataType: "jsonp",jsonp: "callback",
			url: data.serverurl + "/myapi/webapi.php",
			data:{db1},
			success:(db)=>{if(db=='E1'){$("html").html("<p>无法使用...</p>");return};resolve(db)},
			error:(db)=>{$("#a").html(errstr);reject(db)}
		})})
		data.db = db
		maketab()
	}
	async function qd(){data.date1 = $("#mon").val();await getdb(1)}
	async function ssdb(){
		data.ssstr = $('#ssstr').val().replace(/ /g, '')
		$('#ssstr').val(data.ssstr)
		if(data.ssstr){await getdb(2)}
		else{$("#dog p").html('请输入关键词');dog.showModal();return}
	}
	function maketab(){
		let db = data.db
		let dbsum0 = 0 , dbsum1 = 0 ,dbsum2 = 0 , str = ''
		$.each(db,function(n,value){
			let bz1 = value.data1.split("|")
			dbsum0 += +bz1[0]
			dbsum0 = +dbsum0.toFixed(2)
			dbsum1 += +bz1[1]
			dbsum1 = +dbsum1.toFixed(2)
			dbsum2 += +bz1[2]
			dbsum2 = +dbsum2.toFixed(2)
			str += "<div class='item'><div class='itembt' onclick=xiugai("+value.id+")>"+value.id + " - "+value.time.slice(0, 10) + "</div>"
			str += "<div class='itembz'>" + bz1[3] +"</div>"
			str += "<div class='item11'>" + bz1[0] + "-" + bz1[1] + "=" + bz1[2] + "</div>"
			str += "<div class='itemxq'>" + value.data2 + "</div>"
			str += "</div>"
		})
		str += "<div>收入:" + dbsum0 + "支出:" + dbsum1 + "结余:" + dbsum2 + "</div>"
		str += "<div style='width: 95%;margin: 0 auto;'>"
		str += "<input onclick='setmonth(this)' value=" + data.date1 + " readonly='value' size=5 id='mon'>"
		str += '<button onclick=qd()>确定</button>'
		str += '<button onclick=tongji(2)>月计</button>'
		str += '<button onclick=tongji(3)>年计</button>'
		str += '<button onclick=add()>添加</button>'
		str += '<div style="clear:both;height:10px;"></div>'
		str += "<input id='ssstr' value=" + data.ssstr + ">"
		str += "<button onclick=year(-1)>　-　</button>"
		str += "<button onclick=ssdb() id='ss'>搜" +data.year0+ "</button>"
		str += "<button onclick=year(1)>　+　</button>"
		str += "</div>"
		data.maindb = str
		$("#a").html(data.maindb)
		$('#mon').focus()
	}
	function nextmon(date1){return new Date(Date.parse(new Date(date1))+2800000000).toISOString().slice(0, 7)}
	async function add(){
		let db0 = {}
		db0.mode = 1
		db0.opid = data.opid
		db0.sql = `select id from ${data.sqlname} order by id desc limit 1`
		let db1 = js_encrypt(JSON.stringify(db0),"52c7f81cd24c9699","42e07d2f7199c35d")
		$("#a").html(db0.sql)
		let db = await new Promise((resolve,reject)=>{$.ajax({
			type: "get",dataType: "jsonp",jsonp: "callback",
			url: data.serverurl + "/myapi/webapi.php",
			data:{db1},
			success:(db)=>{resolve(db)},
			error:(db)=>{$("#a").html("<p>获取数据失败...</p>");reject(db)}
		})})
		id = +db[0].id + 1
		time = new Date(Date.parse(new Date)+28800000).toISOString().slice(0, 10)
		let str = "<div id=addtab>"
		str += "<table>"
		str += "<tr><td style='width:100px'>ID</td><td><input disabled value = " + id + "></td></tr>"
		str += "<tr><td style='width:100px'>时间</td><td><input value = " + time + "></td></tr>"
		str += "<tr><td>收入</td><td><input ></td></tr>"
		str += "<tr><td>支出</td><td><input ></td></tr>"
		str += "<tr><td>结余</td><td><input ></tr>"
		str += "<tr><td colspan=2><textarea id='bz' rows=6></textarea></td></tr>"
		str += "<tr><td colspan=2><button onclick=fanhui()>返回</button> <button onclick=baocun(1)>保存</button></td></tr>"
		str += "<tr><td colspan=2><textarea rows=6></textarea></td></tr>"
		str += "</table>"
		str += "</div>"
		$("#a").html(str);
		if(data.autosum!=1){data.autosum=1;setTimeout(function(){autosum();},500);}
	}
	async function xiugai(id){
		let db0 = {}
		db0.mode = 1
		db0.opid = data.opid
		db0.sql = `select * from ${data.sqlname} where id = ${id}`
		let db1 = js_encrypt(JSON.stringify(db0),"52c7f81cd24c9699","42e07d2f7199c35d")
		$("#a").html(db0.sql)
		let db = await new Promise((resolve,reject)=>{$.ajax({
			type: "get",dataType: "jsonp",jsonp: "callback",
			url: data.serverurl + "/myapi/webapi.php",
			data:{db1},
			success:(db)=>{resolve(db)},
			error:(db)=>{$("#a").html("<p>获取数据失败...</p>");reject(db)}
		})})
		let data1 = db[0].data1.split("|")
		let str = "<div id=addtab>"
		str += "<table>"
		str += "<tr><td style='width:100px'>ID</td><td><input disabled value = " + db[0].id + "></td></tr>"
		str += "<tr><td style='width:100px'>时间</td><td><input value = " + db[0].time + "></td></tr>"
		str += "<tr><td>收入</td><td><input ></td></tr>"
		str += "<tr><td>支出</td><td><input ></td></tr>"
		str += "<tr><td>结余</td><td><input ></tr>"
		str += "<tr><td colspan=2><textarea id='bz' rows=6>"+data1[3]+"</textarea></td></tr>"
		str += "<tr><td colspan=2><button onclick=fanhui()>返回</button> <button onclick=baocun(2)>保存</button></td></tr>"
		str += "<tr><td colspan=2><textarea rows=6>"+db[0].data2+"</textarea></td></tr>"
		str += "</table>"
		str += "<button onclick=shanchu("+id+")>删除</button><text id='shanchumsg'></text></div>"
		$("#a").html(str);
		if(data.autosum!=1){data.autosum=1;setTimeout(function(){autosum();},500);}
	}
	async function baocun(x){
		let arr = []
		$('input,textarea').each(function(){arr.push($(this).val())})
		if(isNaN(Date.parse(arr[1])) || arr[1].replace(/ /g,'').length !=10){$("#dog p").html('日期格式不正确');	dog.showModal();return}
		if (arr[2]==0 && arr[3]==0 && arr[4]==0){$("#dog p").html('数据不完整！');dog.showModal();return}
		let db0 = {}
		db0.mode = 1
		db0.opid = data.opid
		time = arr[1] + ' 20:00:00'
		data1 = arr[2] + '|' + arr[3] + '|' + arr[4] + '|' + arr[5]
		if(data1.match(/\|/g).length!=3){$("#dog p").html('表单错误请检查:'+data1.match(/\|/g).length);dog.showModal();return}
		data1 = replacePunctuation(data1)
		if(x==1){db0.sql = `insert into ${data.sqlname} (id,time,data1,data2) VALUES ('${arr[0]}','${time}','${data1}','${arr[6]}')`}
		if(x==2){db0.sql = `update ${data.sqlname} set time='${time}',data1='${data1}',data2='${arr[6]}' where id=${arr[0]}`}
		let db1 = js_encrypt(JSON.stringify(db0),"52c7f81cd24c9699","42e07d2f7199c35d")
		$("#a").html(db0.sql)
		let db = await new Promise((resolve,reject)=>{$.ajax({
			type: "get",dataType: "jsonp",jsonp: "callback",
			url: data.serverurl + "/myapi/webapi.php",
			data:{db1},
			success:(db)=>{resolve(db)},
			error:(db)=>{$("#a").html("<p>获取数据失败...</p>");reject(db)}
		})})
		data.autosum=0
		if(data.opid.length==28){await getdb(1)}
	}
	async function shanchu(id){
		let db0 = {}
		db0.mode = 1
		db0.opid = data.opid
		db0.sql = `select id from ${data.sqlname} order by id desc limit 1`
		let db1 = js_encrypt(JSON.stringify(db0),"52c7f81cd24c9699","42e07d2f7199c35d")
		$('#shanchumsg').html(db1);
		let db = await new Promise((resolve,reject)=>{$.ajax({
			type: "get",dataType: "jsonp",jsonp: "callback",
			url: data.serverurl + "/myapi/webapi.php",
			data:{db1},
			success:(db)=>{resolve(db)},
			error:(db)=>{$("#a").html("<p>获取数据失败...</p>");reject(db)}
		})})
		id0 = +db[0].id
		if(+id < id0){$('#shanchumsg').html('不是最后一条记录,不能删除');return}
		$('#shanchumsg').html('等待确认');
		$("#dogbtn").html("<button onclick=shanchu2(" + id + ")>确定</button>")
		$("#dog p").html('确定删除?')
		dog.showModal()
	}
	async function shanchu2(id){
		dog.close()
		let db0 = {}
		db0.mode = 1
		db0.opid = data.opid
		db0.sql = `delete from ${data.sqlname} where id = ${id}`
		let db1 = js_encrypt(JSON.stringify(db0),"52c7f81cd24c9699","42e07d2f7199c35d")
		$('#shanchumsg').html(db1);
		let db = await new Promise((resolve,reject)=>{$.ajax({
			type: "get",dataType: "jsonp",jsonp: "callback",
			url: data.serverurl + "/myapi/webapi.php",
			data:{db1},
			success:(db)=>{resolve(db)},
			error:(db)=>{$("#a").html("<p>获取数据失败...</p>");reject(db)}
		})})
		if(db=='E2'){$('#shanchumsg').html('没有权限');return}
		data.autosum=0
		if(data.opid.length==28){await getdb(1)}
	}
	function autosum(){
		if(data.autosum!=1){return}
		if($('#tishi').html()==""){$('#tishi').html(".")}
		else{$('#tishi').html("")}
		let arr = []
		$('input,textarea').each(function(){arr.push($(this).val())})
		let a = arr[5].split("支出")
		if(a.length==1){
			let num1 = a[0].match(/(\d+\.)?\d+/g)
			var money1 = this.sum(num1)
			var money2 = 0
			var money3 = money1
		}
		if(a.length==2){
			let num1 = a[0].match(/(\d+\.)?\d+/g)
			let num2 = a[1].match(/(\d+\.)?\d+/g)
			var money1 = this.sum(num1)
			var money2 = this.sum(num2)
			var money3 = (money1 - money2).toFixed(2)
			money3 = +money3
		} 
		$("input").eq(2).val(money1)
		$("input").eq(3).val(money2)
		$("input").eq(4).val(money3)
		if(data.autosum==1){setTimeout(function(){autosum()},500);}
  	}
	function sum(arr) {
		if (!arr){return 0}
		let s = 0;
		for(var i=arr.length-1; i>=0; i--){s += +arr[i]}
		return +s.toFixed(2)
	}
	function fanhui(){data.autosum=0;$("#a").html(data.maindb);$('#mon').focus()}
	function replacePunctuation(str) {
		return str.replace(/，/g, ",").replace(/。/g, ".").replace(/；/g, ";").replace(/：/g, ":").replace(/！/g, "!").replace(/？/g, "?");
	}
	function year(y){data.year0 = +data.year0 + +y;$('#ss').text('搜' + data.year0)}
	async function tongji(x){
		$("#a").html('正在加载。。。')
		let db0 = {}
		db0.mode = x
		db0.opid = data.opid
		db0.sql = data.sqlname
		let db1 = js_encrypt(JSON.stringify(db0),"52c7f81cd24c9699","42e07d2f7199c35d")
		$("#a").html(db0.sql)
		let db = await new Promise((resolve,reject)=>{$.ajax({
			type: "get",dataType: "jsonp",jsonp: "callback",
			url: data.serverurl + "/myapi/webapi.php",
			data:{db1},
			success:(db)=>{resolve(db)},
			error:(db)=>{$("#a").html("<p>获取数据失败...</p>");reject(db)}
		})})
		let str = '<table>'
		$.each(db,function(n,value){
			str += '<tr><td>'+ value[0] +'</td><td>'+ value[2] +'</td><td>'+ value[3] +'</td><td>'+ value[4] +'</td></tr>'
		})
		str += '</table>'
		str += "<button onclick=fanhui() id='fanhui'>返回</button>"
		$("#a").html(str)
		$('#fanhui').focus()
	}
</script>
